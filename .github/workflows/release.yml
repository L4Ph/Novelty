name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "バージョン番号 (例: 0.7.0)"
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Calculate new version
        id: calculate_version
        run: |
          CURRENT_VERSION=$(yq '.version' pubspec.yaml)
          if [[ "$CURRENT_VERSION" == *"+"* ]]; then
            BUILD_NUMBER=$(echo "$CURRENT_VERSION" | cut -d'+' -f2)
          else
            BUILD_NUMBER=0
          fi
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          NEW_VERSION="${{ inputs.version }}+${NEW_BUILD_NUMBER}"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$NEW_BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          echo "tag_name=v${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          echo "Generated new version: $NEW_VERSION"

      - name: Update pubspec.yaml version
        run: |
          yq -i '.version = "${{ steps.calculate_version.outputs.new_version }}"' pubspec.yaml
          echo "Updated pubspec.yaml with version: ${{ steps.calculate_version.outputs.new_version }}"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore: Update pubspec.yaml version to ${{ steps.calculate_version.outputs.new_version }} [skip ci]"
          git push origin main

      - name: Create and push tag
        run: |
          git tag ${{ steps.calculate_version.outputs.tag_name }}
          git push origin ${{ steps.calculate_version.outputs.tag_name }}

      - name: Set up Flutter
        run: |
          curl -fsSL https://fvm.app/install.sh | bash
          fvm install

      - name: Get Flutter packages
        run: fvm flutter pub get

      - name: Run code generation
        run: fvm dart run build_runner build -d

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          echo "STORE_FILE=upload-keystore.jks" >> $GITHUB_ENV

      - name: Build Android AAB
        run: |
          fvm flutter build appbundle --release \
            --build-name=${{ inputs.version }} \
            --build-number=${{ steps.calculate_version.outputs.build_number }}
        env:
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Build Android APK (split per ABI)
        run: |
          fvm flutter build apk --release --split-per-abi \
            --build-name=${{ inputs.version }} \
            --build-number=${{ steps.calculate_version.outputs.build_number }}
        env:
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.calculate_version.outputs.tag_name }} \
            --title "Release ${{ inputs.version }}" \
            --generate-notes \
            build/app/outputs/bundle/release/app-release.aab \
            build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk \
            build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
            build/app/outputs/flutter-apk/app-x86_64-release.apk
