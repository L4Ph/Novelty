name: Bump build number

on:
  push:
    branches:
      - main

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Calculate and update version
        id: version
        run: |
          # 現在のバージョンを取得
          current_version=$(yq '.version' pubspec.yaml)
          echo "Current version: $current_version"

          # proud version形式を解析: major.minor.patch+buildNumber
          base_version="${current_version%+*}"
          build_number="${current_version#*+}"

          # build numberが存在しない場合は0とする
          if [[ "$build_number" == "$current_version" ]]; then
            build_number=0
          fi

          # major.minor.patchを分解
          major=$(echo "$base_version" | cut -d. -f1)
          minor=$(echo "$base_version" | cut -d. -f2)
          patch=$(echo "$base_version" | cut -d. -f3)

          # patch番号とbuild番号をインクリメント
          new_patch=$((patch + 1))
          new_build_number=$((build_number + 1))

          # 新しいバージョンを生成
          new_version="${major}.${minor}.${new_patch}+${new_build_number}"
          echo "New version: $new_version"

          # pubspec.yamlを更新
          yq -i ".version = \"$new_version\"" pubspec.yaml

          # 後続のステップで使用するために環境変数に保存
          echo "NEW_VERSION=$new_version" >> "$GITHUB_ENV"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update pubspec.yaml version to $NEW_VERSION [skip ci]"
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
