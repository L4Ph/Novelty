[tools]
bun = "latest"
flutter = "3.38.7-stable"
java = "temurin-21"
node = "latest"

[env]
MISE_EXPERIMENTAL = "true"
ADB_SERVER_SOCKET = "tcp:127.0.0.1:5037"
ANDROID_HOME = "/opt/android-sdk"
ANDROID_SDK_ROOT = "/opt/android-sdk"
FLUTTER_SDK = "{{ exec(command=mise_bin ~ ' where flutter') | trim }}"
FLUTTER_BIN = "{{ exec(command=mise_bin ~ ' where flutter') | trim }}/bin/flutter"
FLUTTER_ROOT = "{{ exec(command=mise_bin ~ ' where flutter') | trim }}"

[tasks.setup]
description = "Android/Flutterの開発環境をセットアップします (local.propertiesの同期など)"
run = """
cat <<EOF > android/local.properties
sdk.dir=$ANDROID_HOME
flutter.sdk=$FLUTTER_SDK
EOF
echo "android/local.properties has been updated with SDK path: $FLUTTER_SDK"
"""

[tasks.get]
description = "パッケージの依存関係を取得します"
depends = ["setup"]
run = "flutter pub get"

[tasks.emulator]
description = "Androidエミュレータを起動します"
run = "emulator -avd pixel_16 -gpu host"

[tasks.run]
description = "アプリケーションを実行します"
depends = ["setup"]
run = "flutter run"

[tasks.check]
description = "コードの静的解析とフォーマットをチェックします"
run = "dart analyze && dart format --dry-run ."

[tasks.build]
description = "リリース用APK (分割) と App Bundleをビルドします"
depends = ["setup"]
run = """
flutter build apk --release --split-per-abi
flutter build appbundle --release
"""

[tasks.clean]
description = "ビルドアーティファクトを削除します"
run = "flutter clean"

[tasks.test]
description = "ユニットテストを実行します"
run = "flutter test"

[tasks.analyze]
description = "コードの静的解析を行います"
run = "flutter analyze"

[tasks.format]
description = "コードのフォーマットを整えます"
run = "dart format ."

[tasks.doctor]
description = "Flutterの開発環境を確認します"
run = "flutter doctor"

[tasks.codegen]
description = "build_runnerでコード生成を1回実行します"
run = "flutter pub run build_runner build --delete-conflicting-outputs"

[tasks.watch]
description = "build_runnerをウォッチモードで実行します"
run = "flutter pub run build_runner watch --delete-conflicting-outputs"

[tasks.release]
description = "GitHubリリースを作成し、デプロイします"
run = """
VERSION="v$(yq -r .version pubspec.yaml | cut -d+ -f1)"
gh release create "$VERSION" --title "$VERSION" --generate-notes \
  build/app/outputs/bundle/release/app-release.aab \
  build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk \
  build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
  build/app/outputs/flutter-apk/app-x86_64-release.apk
"""
